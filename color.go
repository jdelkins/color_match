package main

import (
	"fmt"
	"math"
	"os"

	"github.com/lucasb-eyer/go-colorful"
	"github.com/pborman/getopt/v2"
)

var (
	mycolors    map[string]colorful.Color
	xtermcolors []colorful.Color
	outFormat   *string
)

func minKey(m map[string]float64) string {
	mink, minv := "", math.MaxFloat64
	for k, v := range m {
		if v < minv {
			minv = v
			mink = k
		}
	}
	return mink
}

func BestMycolor(tgt *colorful.Color) string {
	dist := make(map[string]float64)
	for n, c := range mycolors {
		dist[n] = tgt.DistanceLab(c)
	}
	return minKey(dist)
}

func initMyColors() {
	mycolor_names := []string{
		"bg",
		"black",
		"blue",
		"cyan",
		"fg",
		"green",
		"grey01",
		"grey02",
		"grey03",
		"grey1",
		"grey2",
		"grey3",
		"magenta",
		"orange",
		"red",
		"violet",
		"white",
		"yellow",
	}
	mycolors = make(map[string]colorful.Color)
	for _, c := range mycolor_names {
		h, _ := colorful.Hex(os.Getenv("mycolor_" + c))
		mycolors[c] = h
	}
}

func c(r, g, b uint8) colorful.Color {
	return colorful.Color{
		R: float64(r) / 255.0,
		G: float64(g) / 255.0,
		B: float64(b) / 255.0,
	}
}

func initXtermColors() {
	xtermcolors = make([]colorful.Color, 256)

	xtermcolors[0] = c(0x00, 0x00, 0x00)
	xtermcolors[1] = c(0xcd, 0x00, 0x00)
	xtermcolors[2] = c(0x00, 0xcd, 0x00)
	xtermcolors[3] = c(0xcd, 0xcd, 0x00)
	xtermcolors[4] = c(0x00, 0x00, 0xee)
	xtermcolors[5] = c(0xcd, 0x00, 0xcd)
	xtermcolors[6] = c(0x00, 0xcd, 0xcd)
	xtermcolors[7] = c(0xe5, 0xe5, 0xe5)
	xtermcolors[8] = c(0x7f, 0x7f, 0x7f)
	xtermcolors[9] = c(0xff, 0x00, 0x00)
	xtermcolors[10] = c(0x00, 0xff, 0x00)
	xtermcolors[11] = c(0xff, 0xff, 0x00)
	xtermcolors[12] = c(0x5c, 0x5c, 0xff)
	xtermcolors[13] = c(0xff, 0x00, 0xff)
	xtermcolors[14] = c(0x00, 0xff, 0xff)
	xtermcolors[15] = c(0xff, 0xff, 0xff)
	xtermcolors[16] = c(0x00, 0x00, 0x00)
	xtermcolors[17] = c(0x00, 0x00, 0x5f)
	xtermcolors[18] = c(0x00, 0x00, 0x87)
	xtermcolors[19] = c(0x00, 0x00, 0xaf)
	xtermcolors[20] = c(0x00, 0x00, 0xd7)
	xtermcolors[21] = c(0x00, 0x00, 0xff)
	xtermcolors[22] = c(0x00, 0x5f, 0x00)
	xtermcolors[23] = c(0x00, 0x5f, 0x5f)
	xtermcolors[24] = c(0x00, 0x5f, 0x87)
	xtermcolors[25] = c(0x00, 0x5f, 0xaf)
	xtermcolors[26] = c(0x00, 0x5f, 0xd7)
	xtermcolors[27] = c(0x00, 0x5f, 0xff)
	xtermcolors[28] = c(0x00, 0x87, 0x00)
	xtermcolors[29] = c(0x00, 0x87, 0x5f)
	xtermcolors[30] = c(0x00, 0x87, 0x87)
	xtermcolors[31] = c(0x00, 0x87, 0xaf)
	xtermcolors[32] = c(0x00, 0x87, 0xd7)
	xtermcolors[33] = c(0x00, 0x87, 0xff)
	xtermcolors[34] = c(0x00, 0xaf, 0x00)
	xtermcolors[35] = c(0x00, 0xaf, 0x5f)
	xtermcolors[36] = c(0x00, 0xaf, 0x87)
	xtermcolors[37] = c(0x00, 0xaf, 0xaf)
	xtermcolors[38] = c(0x00, 0xaf, 0xd7)
	xtermcolors[39] = c(0x00, 0xaf, 0xff)
	xtermcolors[40] = c(0x00, 0xd7, 0x00)
	xtermcolors[41] = c(0x00, 0xd7, 0x5f)
	xtermcolors[42] = c(0x00, 0xd7, 0x87)
	xtermcolors[43] = c(0x00, 0xd7, 0xaf)
	xtermcolors[44] = c(0x00, 0xd7, 0xd7)
	xtermcolors[45] = c(0x00, 0xd7, 0xff)
	xtermcolors[46] = c(0x00, 0xff, 0x00)
	xtermcolors[47] = c(0x00, 0xff, 0x5f)
	xtermcolors[48] = c(0x00, 0xff, 0x87)
	xtermcolors[49] = c(0x00, 0xff, 0xaf)
	xtermcolors[50] = c(0x00, 0xff, 0xd7)
	xtermcolors[51] = c(0x00, 0xff, 0xff)
	xtermcolors[52] = c(0x5f, 0x00, 0x00)
	xtermcolors[53] = c(0x5f, 0x00, 0x5f)
	xtermcolors[54] = c(0x5f, 0x00, 0x87)
	xtermcolors[55] = c(0x5f, 0x00, 0xaf)
	xtermcolors[56] = c(0x5f, 0x00, 0xd7)
	xtermcolors[57] = c(0x5f, 0x00, 0xff)
	xtermcolors[58] = c(0x5f, 0x5f, 0x00)
	xtermcolors[59] = c(0x5f, 0x5f, 0x5f)
	xtermcolors[60] = c(0x5f, 0x5f, 0x87)
	xtermcolors[61] = c(0x5f, 0x5f, 0xaf)
	xtermcolors[62] = c(0x5f, 0x5f, 0xd7)
	xtermcolors[63] = c(0x5f, 0x5f, 0xff)
	xtermcolors[64] = c(0x5f, 0x87, 0x00)
	xtermcolors[65] = c(0x5f, 0x87, 0x5f)
	xtermcolors[66] = c(0x5f, 0x87, 0x87)
	xtermcolors[67] = c(0x5f, 0x87, 0xaf)
	xtermcolors[68] = c(0x5f, 0x87, 0xd7)
	xtermcolors[69] = c(0x5f, 0x87, 0xff)
	xtermcolors[70] = c(0x5f, 0xaf, 0x00)
	xtermcolors[71] = c(0x5f, 0xaf, 0x5f)
	xtermcolors[72] = c(0x5f, 0xaf, 0x87)
	xtermcolors[73] = c(0x5f, 0xaf, 0xaf)
	xtermcolors[74] = c(0x5f, 0xaf, 0xd7)
	xtermcolors[75] = c(0x5f, 0xaf, 0xff)
	xtermcolors[76] = c(0x5f, 0xd7, 0x00)
	xtermcolors[77] = c(0x5f, 0xd7, 0x5f)
	xtermcolors[78] = c(0x5f, 0xd7, 0x87)
	xtermcolors[79] = c(0x5f, 0xd7, 0xaf)
	xtermcolors[80] = c(0x5f, 0xd7, 0xd7)
	xtermcolors[81] = c(0x5f, 0xd7, 0xff)
	xtermcolors[82] = c(0x5f, 0xff, 0x00)
	xtermcolors[83] = c(0x5f, 0xff, 0x5f)
	xtermcolors[84] = c(0x5f, 0xff, 0x87)
	xtermcolors[85] = c(0x5f, 0xff, 0xaf)
	xtermcolors[86] = c(0x5f, 0xff, 0xd7)
	xtermcolors[87] = c(0x5f, 0xff, 0xff)
	xtermcolors[88] = c(0x87, 0x00, 0x00)
	xtermcolors[89] = c(0x87, 0x00, 0x5f)
	xtermcolors[90] = c(0x87, 0x00, 0x87)
	xtermcolors[91] = c(0x87, 0x00, 0xaf)
	xtermcolors[92] = c(0x87, 0x00, 0xd7)
	xtermcolors[93] = c(0x87, 0x00, 0xff)
	xtermcolors[94] = c(0x87, 0x5f, 0x00)
	xtermcolors[95] = c(0x87, 0x5f, 0x5f)
	xtermcolors[96] = c(0x87, 0x5f, 0x87)
	xtermcolors[97] = c(0x87, 0x5f, 0xaf)
	xtermcolors[98] = c(0x87, 0x5f, 0xd7)
	xtermcolors[99] = c(0x87, 0x5f, 0xff)
	xtermcolors[100] = c(0x87, 0x87, 0x00)
	xtermcolors[101] = c(0x87, 0x87, 0x5f)
	xtermcolors[102] = c(0x87, 0x87, 0x87)
	xtermcolors[103] = c(0x87, 0x87, 0xaf)
	xtermcolors[104] = c(0x87, 0x87, 0xd7)
	xtermcolors[105] = c(0x87, 0x87, 0xff)
	xtermcolors[106] = c(0x87, 0xaf, 0x00)
	xtermcolors[107] = c(0x87, 0xaf, 0x5f)
	xtermcolors[108] = c(0x87, 0xaf, 0x87)
	xtermcolors[109] = c(0x87, 0xaf, 0xaf)
	xtermcolors[110] = c(0x87, 0xaf, 0xd7)
	xtermcolors[111] = c(0x87, 0xaf, 0xff)
	xtermcolors[112] = c(0x87, 0xd7, 0x00)
	xtermcolors[113] = c(0x87, 0xd7, 0x5f)
	xtermcolors[114] = c(0x87, 0xd7, 0x87)
	xtermcolors[115] = c(0x87, 0xd7, 0xaf)
	xtermcolors[116] = c(0x87, 0xd7, 0xd7)
	xtermcolors[117] = c(0x87, 0xd7, 0xff)
	xtermcolors[118] = c(0x87, 0xff, 0x00)
	xtermcolors[119] = c(0x87, 0xff, 0x5f)
	xtermcolors[120] = c(0x87, 0xff, 0x87)
	xtermcolors[121] = c(0x87, 0xff, 0xaf)
	xtermcolors[122] = c(0x87, 0xff, 0xd7)
	xtermcolors[123] = c(0x87, 0xff, 0xff)
	xtermcolors[124] = c(0xaf, 0x00, 0x00)
	xtermcolors[125] = c(0xaf, 0x00, 0x5f)
	xtermcolors[126] = c(0xaf, 0x00, 0x87)
	xtermcolors[127] = c(0xaf, 0x00, 0xaf)
	xtermcolors[128] = c(0xaf, 0x00, 0xd7)
	xtermcolors[129] = c(0xaf, 0x00, 0xff)
	xtermcolors[130] = c(0xaf, 0x5f, 0x00)
	xtermcolors[131] = c(0xaf, 0x5f, 0x5f)
	xtermcolors[132] = c(0xaf, 0x5f, 0x87)
	xtermcolors[133] = c(0xaf, 0x5f, 0xaf)
	xtermcolors[134] = c(0xaf, 0x5f, 0xd7)
	xtermcolors[135] = c(0xaf, 0x5f, 0xff)
	xtermcolors[136] = c(0xaf, 0x87, 0x00)
	xtermcolors[137] = c(0xaf, 0x87, 0x5f)
	xtermcolors[138] = c(0xaf, 0x87, 0x87)
	xtermcolors[139] = c(0xaf, 0x87, 0xaf)
	xtermcolors[140] = c(0xaf, 0x87, 0xd7)
	xtermcolors[141] = c(0xaf, 0x87, 0xff)
	xtermcolors[142] = c(0xaf, 0xaf, 0x00)
	xtermcolors[143] = c(0xaf, 0xaf, 0x5f)
	xtermcolors[144] = c(0xaf, 0xaf, 0x87)
	xtermcolors[145] = c(0xaf, 0xaf, 0xaf)
	xtermcolors[146] = c(0xaf, 0xaf, 0xd7)
	xtermcolors[147] = c(0xaf, 0xaf, 0xff)
	xtermcolors[148] = c(0xaf, 0xd7, 0x00)
	xtermcolors[149] = c(0xaf, 0xd7, 0x5f)
	xtermcolors[150] = c(0xaf, 0xd7, 0x87)
	xtermcolors[151] = c(0xaf, 0xd7, 0xaf)
	xtermcolors[152] = c(0xaf, 0xd7, 0xd7)
	xtermcolors[153] = c(0xaf, 0xd7, 0xff)
	xtermcolors[154] = c(0xaf, 0xff, 0x00)
	xtermcolors[155] = c(0xaf, 0xff, 0x5f)
	xtermcolors[156] = c(0xaf, 0xff, 0x87)
	xtermcolors[157] = c(0xaf, 0xff, 0xaf)
	xtermcolors[158] = c(0xaf, 0xff, 0xd7)
	xtermcolors[159] = c(0xaf, 0xff, 0xff)
	xtermcolors[160] = c(0xd7, 0x00, 0x00)
	xtermcolors[161] = c(0xd7, 0x00, 0x5f)
	xtermcolors[162] = c(0xd7, 0x00, 0x87)
	xtermcolors[163] = c(0xd7, 0x00, 0xaf)
	xtermcolors[164] = c(0xd7, 0x00, 0xd7)
	xtermcolors[165] = c(0xd7, 0x00, 0xff)
	xtermcolors[166] = c(0xd7, 0x5f, 0x00)
	xtermcolors[167] = c(0xd7, 0x5f, 0x5f)
	xtermcolors[168] = c(0xd7, 0x5f, 0x87)
	xtermcolors[169] = c(0xd7, 0x5f, 0xaf)
	xtermcolors[170] = c(0xd7, 0x5f, 0xd7)
	xtermcolors[171] = c(0xd7, 0x5f, 0xff)
	xtermcolors[172] = c(0xd7, 0x87, 0x00)
	xtermcolors[173] = c(0xd7, 0x87, 0x5f)
	xtermcolors[174] = c(0xd7, 0x87, 0x87)
	xtermcolors[175] = c(0xd7, 0x87, 0xaf)
	xtermcolors[176] = c(0xd7, 0x87, 0xd7)
	xtermcolors[177] = c(0xd7, 0x87, 0xff)
	xtermcolors[178] = c(0xd7, 0xaf, 0x00)
	xtermcolors[179] = c(0xd7, 0xaf, 0x5f)
	xtermcolors[180] = c(0xd7, 0xaf, 0x87)
	xtermcolors[181] = c(0xd7, 0xaf, 0xaf)
	xtermcolors[182] = c(0xd7, 0xaf, 0xd7)
	xtermcolors[183] = c(0xd7, 0xaf, 0xff)
	xtermcolors[184] = c(0xd7, 0xd7, 0x00)
	xtermcolors[185] = c(0xd7, 0xd7, 0x5f)
	xtermcolors[186] = c(0xd7, 0xd7, 0x87)
	xtermcolors[187] = c(0xd7, 0xd7, 0xaf)
	xtermcolors[188] = c(0xd7, 0xd7, 0xd7)
	xtermcolors[189] = c(0xd7, 0xd7, 0xff)
	xtermcolors[190] = c(0xd7, 0xff, 0x00)
	xtermcolors[191] = c(0xd7, 0xff, 0x5f)
	xtermcolors[192] = c(0xd7, 0xff, 0x87)
	xtermcolors[193] = c(0xd7, 0xff, 0xaf)
	xtermcolors[194] = c(0xd7, 0xff, 0xd7)
	xtermcolors[195] = c(0xd7, 0xff, 0xff)
	xtermcolors[196] = c(0xff, 0x00, 0x00)
	xtermcolors[197] = c(0xff, 0x00, 0x5f)
	xtermcolors[198] = c(0xff, 0x00, 0x87)
	xtermcolors[199] = c(0xff, 0x00, 0xaf)
	xtermcolors[200] = c(0xff, 0x00, 0xd7)
	xtermcolors[201] = c(0xff, 0x00, 0xff)
	xtermcolors[202] = c(0xff, 0x5f, 0x00)
	xtermcolors[203] = c(0xff, 0x5f, 0x5f)
	xtermcolors[204] = c(0xff, 0x5f, 0x87)
	xtermcolors[205] = c(0xff, 0x5f, 0xaf)
	xtermcolors[206] = c(0xff, 0x5f, 0xd7)
	xtermcolors[207] = c(0xff, 0x5f, 0xff)
	xtermcolors[208] = c(0xff, 0x87, 0x00)
	xtermcolors[209] = c(0xff, 0x87, 0x5f)
	xtermcolors[210] = c(0xff, 0x87, 0x87)
	xtermcolors[211] = c(0xff, 0x87, 0xaf)
	xtermcolors[212] = c(0xff, 0x87, 0xd7)
	xtermcolors[213] = c(0xff, 0x87, 0xff)
	xtermcolors[214] = c(0xff, 0xaf, 0x00)
	xtermcolors[215] = c(0xff, 0xaf, 0x5f)
	xtermcolors[216] = c(0xff, 0xaf, 0x87)
	xtermcolors[217] = c(0xff, 0xaf, 0xaf)
	xtermcolors[218] = c(0xff, 0xaf, 0xd7)
	xtermcolors[219] = c(0xff, 0xaf, 0xff)
	xtermcolors[220] = c(0xff, 0xd7, 0x00)
	xtermcolors[221] = c(0xff, 0xd7, 0x5f)
	xtermcolors[222] = c(0xff, 0xd7, 0x87)
	xtermcolors[223] = c(0xff, 0xd7, 0xaf)
	xtermcolors[224] = c(0xff, 0xd7, 0xd7)
	xtermcolors[225] = c(0xff, 0xd7, 0xff)
	xtermcolors[226] = c(0xff, 0xff, 0x00)
	xtermcolors[227] = c(0xff, 0xff, 0x5f)
	xtermcolors[228] = c(0xff, 0xff, 0x87)
	xtermcolors[229] = c(0xff, 0xff, 0xaf)
	xtermcolors[230] = c(0xff, 0xff, 0xd7)
	xtermcolors[231] = c(0xff, 0xff, 0xff)
	xtermcolors[232] = c(0x08, 0x08, 0x08)
	xtermcolors[233] = c(0x12, 0x12, 0x12)
	xtermcolors[234] = c(0x1c, 0x1c, 0x1c)
	xtermcolors[235] = c(0x26, 0x26, 0x26)
	xtermcolors[236] = c(0x30, 0x30, 0x30)
	xtermcolors[237] = c(0x3a, 0x3a, 0x3a)
	xtermcolors[238] = c(0x44, 0x44, 0x44)
	xtermcolors[239] = c(0x4e, 0x4e, 0x4e)
	xtermcolors[240] = c(0x58, 0x58, 0x58)
	xtermcolors[241] = c(0x62, 0x62, 0x62)
	xtermcolors[242] = c(0x6c, 0x6c, 0x6c)
	xtermcolors[243] = c(0x76, 0x76, 0x76)
	xtermcolors[244] = c(0x80, 0x80, 0x80)
	xtermcolors[245] = c(0x8a, 0x8a, 0x8a)
	xtermcolors[246] = c(0x94, 0x94, 0x94)
	xtermcolors[247] = c(0x9e, 0x9e, 0x9e)
	xtermcolors[248] = c(0xa8, 0xa8, 0xa8)
	xtermcolors[249] = c(0xb2, 0xb2, 0xb2)
	xtermcolors[250] = c(0xbc, 0xbc, 0xbc)
	xtermcolors[251] = c(0xc6, 0xc6, 0xc6)
	xtermcolors[252] = c(0xd0, 0xd0, 0xd0)
	xtermcolors[253] = c(0xda, 0xda, 0xda)
	xtermcolors[254] = c(0xe4, 0xe4, 0xe4)
	xtermcolors[255] = c(0xee, 0xee, 0xee)
}

func output(k string) {
	c := mycolors[k]
	if *outFormat != "" {
		fmt.Printf(*outFormat, c.Hex())
	} else {
		fmt.Printf("mycolor_%s", k)
	}
}

func main() {
	helpFlag := getopt.BoolLong("help", 'h', "display help")
	ansiColor := getopt.IntLong("ansi", 'a', -1, "match 'standard' ansi 256 color value")
	hexColor := getopt.StringLong("hex", 'x', "", "match hex color in #ffffff format")
	outFormat = getopt.StringLong("format", 'f', "", "output format. use %s for the hex value")
	getopt.Parse()

	if *helpFlag {
		getopt.PrintUsage(os.Stdout)
		return
	}

	if (*ansiColor < 0 && *hexColor == "") || (*ansiColor >= 0 && *hexColor != "") || *ansiColor > 255 {
		getopt.Usage()
		os.Exit(1)
	}

	initMyColors()
	if *ansiColor >= 0 {
		initXtermColors()
		output(BestMycolor(&xtermcolors[*ansiColor]))
	} else {
		col, err := colorful.Hex(*hexColor)
		if err != nil {
			fmt.Fprintf(os.Stderr, "%s: invalid hex color spec: %s\n", os.Args[0], *hexColor)
			os.Exit(1)
		}
		output(BestMycolor(&col))
	}
}
